{% extends 'base.html' %}
{% load static %}

{% block title %}
    Registro de Venta
{% endblock %}

{% block titulo %}
    Registrar Venta
{% endblock %}

{% block content %}

    <h2>Registrar Venta</h2>

    <form method="post">
        {% csrf_token %}
        {{ venta_form.as_p }}
        <br>

        <!-- Formulario de la venta -->
        <div class="container mb-4">
            <div>
                <h4>Información de la Venta</h4>
                <label for="producto">Producto:</label>
            <select id="producto" class="form-control" >
                <option value="">Seleccione un Producto</option>
                {% for producto in productos %}
                    <option value="{{ producto.id }}">{{ producto.nombre }}</option>
                {% endfor %}
            </select>

            <label for="cantidad">Cantidad:</label>
            <input type="number" id="cantidad" min="1" class="form-control"> <br>
            <div class="mb-1 container text-center">
                <button class="btn bg-primary" type="button" onclick="agregarItem()">Agregar Item</button>
            </div>

         <!-- Tabla para mostrar los items agregados -->
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Producto</th>
                    <th>Cantidad</th>
                    <th>Acción</th>
                </tr>
            </thead>
            <tbody id="detallesTabla">
                <!-- Las filas se agregarán dinámicamente aquí -->
            </tbody>
        </table>
        <br><br>
            </div>



        </div>
         <button type="submit" class="btn btn-primary mt-4">Guardar Venta</button>
    </form>

<script>
        function agregarItem() {
            // Obtener los valores de los campos de insumo y cantidad
            const productoSelect = document.getElementById('producto');
            const productoText = productoSelect.options[productoSelect.selectedIndex].text;
            const productoId = productoSelect.value;
            const cantidad = document.getElementById('cantidad').value;

            if (!productoId || !cantidad) {
                alert('Por favor, seleccione un producto y una cantidad válida.');
                return;
            }

            // Crear una nueva fila en la tabla
            const nuevaFila = document.createElement('tr');
            nuevaFila.innerHTML = `
                <td>
                    <input type="hidden" name="producto_id[]" value="${productoId}">
                    ${productoText}
                </td>
                <td>
                    <input type="hidden" name="cantidad[]" value="${cantidad}">
                    ${cantidad}
                </td>
                <td>
                    <button class="btn bg-danger" type="button" onclick="eliminarFila(this)">Eliminar</button>
                </td>
            `;

            // Agregar la nueva fila a la tabla
            document.getElementById('detallesTabla').appendChild(nuevaFila);

            // Limpiar los campos de producto y cantidad
            productoSelect.value = '';
            document.getElementById('cantidad').value = '';
        }

        function eliminarFila(boton) {
            // Eliminar la fila correspondiente
            const fila = boton.closest('tr');
            fila.remove();
        }
 </script>
{% endblock %}

        <!-- Secciones Formset
        <div class="container">
            <div class="card-body">
                <h4>Items</h4>
                {{ formset.management_form }}
                <div id="formset-container">
                    {% for form in formset %}
                    <div class="item-form mb-3 p-3 border rounded">
                        {{ form.as_p }}
                    </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn btn-secondary" id="add-form">Agregar Item</button>
            </div>
        </div> -->


<!--<script>
document.addEventListener('DOMContentLoaded', function() {
    const addButton = document.getElementById('add-form');
    const formsetContainer = document.getElementById('formset-container');
    const totalForms = document.getElementById('id_secciones-TOTAL_FORMS');

    // Función para actualizar los índices de los formularios
    function updateFormIndexes() {
        const forms = formsetContainer.getElementsByClassName('item-form');
        for (let i = 0; i < forms.length; i++) {
            const formInputs = forms[i].getElementsByTagName('input');
            const formSelects = forms[i].getElementsByTagName('select');

            for (let input of formInputs) {
                updateElementIndex(input, 'secciones', i);
            }
            for (let select of formSelects) {
                updateElementIndex(select, 'secciones', i);
            }
        }
        totalForms.value = forms.length;
    }

    // Función para actualizar el índice de un elemento
    function updateElementIndex(element, prefix, index) {
        const idRegex = new RegExp(`(${prefix}-\\d+)`);
        const replacement = `${prefix}-${index}`;
        if (element.id) element.id = element.id.replace(idRegex, replacement);
        if (element.name) element.name = element.name.replace(idRegex, replacement);
    }

    // Agregar nuevo formulario
    addButton.addEventListener('click', function(e) {
        e.preventDefault();
        const formCount = formsetContainer.children.length;
        const template = formsetContainer.children[0].cloneNode(true);

        // Limpiar los valores del formulario clonado
        template.querySelectorAll('input[type="text"]').forEach(input => input.value = '');
        template.querySelectorAll('input[type="number"]').forEach(input => input.value = '');
        template.querySelectorAll('select').forEach(select => select.selectedIndex = 0);

        formsetContainer.appendChild(template);
        updateFormIndexes();
    });

    // Eliminar formulario
    formsetContainer.addEventListener('click', function(e) {
        if (e.target.classList.contains('delete-form')) {
            e.preventDefault();
            const form = e.target.closest('.item-form');
            form.remove();
            updateFormIndexes();
        }
    });
});
</script>-->



